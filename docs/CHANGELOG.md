# Changelog

## 2026-02-21
Drinking Window feature (Step 16). Added an optional `consumeStartingFrom` field (YYYY year format) to the bottle data model, serialization, and validation. The Add Bottle form includes a "Drink from" year input with validation that the year is not earlier than the vintage. The Edit Bottle modal includes the same field as an editable input. BottleCard displays a green "Ready to drink" badge when `consumeStartingFrom <= current year` and quantity > 0. BottleDetail shows "Drink from YYYY" when the field is set. Dashboard now includes a "Bottles to Drink This Year" section (after Statistics, before Recent Bottles) showing up to 5 bottles ready to drink, hidden when none match. Search has a new "Ready to drink" toggle filter in the FilterPanel that filters by `consumeStartingFrom <= currentYear` and quantity > 0, counted in active filters and reset by "Clear all filters". Added 36 new tests across bottle-serializer, form-utils, edit-bottle-utils, dashboard-utils, search-utils, BottleCard, and BottleDetail. All 526 Vitest tests pass. No new dependencies added.

## 2026-02-18
Manual Sync with Queue Counter (Step 15). Replaced the auto-sync model (which pushed to GitHub after every mutation) with a fully manual sync model. Every local change (add, consume, edit, remove) now only queues a sync entry in IndexedDB via `enqueueMutation()` — no GitHub API calls are made until the user explicitly triggers sync. A new `SyncButton` component in the header shows the number of pending changes as a badge with context-aware icons: upload arrow when changes are pending, download arrow when synced, spinning icon while syncing, and warning icon on conflict. Clicking the button calls `manualPush()` (when queue has items) or `manualPull()` (when empty). Removed all automatic retry logic (`attemptSync()`, `processQueue()`, `calculateBackoffDelay()`, `scheduleRetry()`, exponential backoff state) from `sync-manager.ts`. Settings sync section renamed to "Force Sync Options" with "Force Push (create PR)" calling `createConflictPR()` directly and "Force Pull (overwrite local)" for recovery scenarios. Removed `cancelRetries()` calls from `ConflictModal` and `SyncSection`. Added 16 new SyncButton component tests. Rewrote sync-manager tests (20 tests covering `enqueueMutation`, `manualPush`, `manualPull`). Updated bottle-actions, AddBottle, EditBottle, SyncSection, ConflictModal, and App tests. All 490 Vitest tests pass. No new dependencies added.

## 2026-02-17
Quick Consume/Remove Actions (Step 14). Added consume (−1) and remove (✕) icon buttons to BottleCard and BottleDetail views, allowing single-bottle actions directly from the dashboard, search results, and detail modal. Buttons are hidden when quantity is 0. Each action creates a history entry (consumed/removed, quantity 1, today's date), updates IndexedDB via `updateBottle()`, triggers GitHub sync via `attemptSync()`, and shows a success toast. Event propagation is stopped so card clicks don't open the detail modal. Added `createConsumeHistoryEntry()`, `createRemoveHistoryEntry()`, and `applyHistoryEntry()` helpers in bottle-utils, plus `consumeBottle()` and `removeBottle()` action handlers in a new bottle-actions module. Added 51 new tests across bottle-utils, bottle-actions, BottleCard, and BottleDetail. All 494 Vitest tests pass. No new dependencies added.

## 2026-02-16
Update Bottle Rating & Notes (Step 13). Tapping a BottleCard now opens a full-page detail modal displaying all bottle fields (name, vintage, type, origin, grape varieties, location, rating, notes) and the full history timeline with date, action, quantity, price, and notes per entry. An Edit button opens an edit modal overlay where key fields (name, vintage, type) are visible but disabled, and all other fields (rating, notes, location, country, region, grape variety) are editable with autocomplete and tag input reuse. Saving updates IndexedDB via `updateBottle()`, triggers GitHub sync via `attemptSync()`, shows a success toast, and refreshes the detail view. Dashboard now includes a "Recent Bottles" section with clickable BottleCards. Added 39 new tests across BottleDetail, EditBottle, HistoryTimeline, edit-bottle-utils, and updated BottleCard/Dashboard/Search tests. All 443 Vitest tests pass. No new dependencies added.

## 2026-02-16
Autocomplete for Country & Region (Step 12). Created a reusable TextAutocomplete component that shows a dropdown of all suggestions on focus, filters with case-insensitive "contains" matching as the user types, highlights the matched portion, and supports full keyboard navigation (arrow keys, Enter, Escape). Replaced the plain Country and Region text inputs in the Add Bottle form with TextAutocomplete, populated with unique values extracted from existing bottles. Free-text entry remains allowed for new values not yet in the cellar. Fields become disabled when an existing bottle is selected (preserving read-only behavior). Full ARIA support (combobox role, listbox, aria-expanded, aria-activedescendant). Added 21 unit tests for TextAutocomplete and 4 integration tests in AddBottle. All 403 Vitest tests pass. No new dependencies added.

## 2026-02-16
Polish & Optimization (Step 11). Removed the hard bundle size constraint in favor of trusting the inherently lightweight Svelte + Vite + Tailwind stack. Added a custom toast notification system with success, error, and info variants that auto-dismiss after a configurable duration, integrated across Add Bottle, Sync, Settings, and Conflict Resolution flows. Audited and improved error handling by wrapping all async code paths in try/catch and adding a global unhandled promise rejection handler that surfaces errors via toast. Implemented full PWA support with a Web App Manifest (name, icons, start_url, display: standalone), Service Worker with cache-first strategy for static assets and offline navigation fallback, and automatic new-version notification. Added Playwright E2E tests (Chromium-only) for adding a bottle, searching/filtering, and view navigation. Fixed a Svelte 5 reactivity bug where `$state` proxy arrays could not be cloned by IndexedDB. All 378 Vitest tests and 5 Playwright E2E tests pass.

## 2026-02-16
Implemented Autocomplete for Duplicate Prevention (Step 10). The Add Bottle form now features name-based autocomplete that proactively prevents duplicate bottle creation. As users type 2+ characters in the name field, a dropdown displays matching bottles with name, vintage, type badge, and current quantity. Selecting an existing bottle auto-fills all form fields and displays an info banner showing bottle details. Non-key fields (country, region, grape variety, location, rating, bottle notes) become read-only, while key fields (name, vintage, type) and history-entry fields (quantity, price, currency, purchase notes) remain editable. When key fields change, duplicate detection re-runs reactively: if a match is found, that bottle is selected and the form updates; if no match exists, the form reverts to "new bottle" mode with all fields editable. Submitting with an existing bottle selected adds a history entry to that bottle instead of creating a new one. The autocomplete dropdown supports full keyboard navigation (arrow keys, Enter to select, Escape to close). The old post-submit duplicate confirmation banner has been replaced by this proactive workflow. Added `searchBottlesByName()` utility function, custom NameAutocomplete Svelte component, and comprehensive tests (28 new tests across bottle-utils.test.ts, NameAutocomplete.test.ts, and updated AddBottle.test.ts). No external dependencies were added — the autocomplete is a custom implementation optimized for the small dataset (~100 bottles max).

## 2026-02-15
Implemented Conflict Resolution (Step 9). When pushing local changes, the app detects if the remote GitHub repository has diverged by comparing the stored last-synced commit SHA against the remote HEAD. On conflict, a modal presents two resolution options: "Create Pull Request" (pushes local bottles to a timestamped `conflict/YYYY-MM-DD-HHmmss` branch and opens a PR) or "Use Remote Data" (overwrites local data with the remote state, clearing the sync queue). A new orange "Conflict" sync status indicator appears in the header, and the sync manager stops retrying on conflict detection.

## 2026-02-15
Implemented Offline Capability & Sync Queue (Step 8). When a GitHub sync fails due to network issues, local changes are preserved in a persistent IndexedDB sync queue and automatically retried with exponential backoff (up to 10 retries, capped at 60s delay). The header sync status indicator now shows five distinct states (not-configured, connected, offline, syncing, error) with pending change count (e.g., "Offline (3 pending)"). On app startup, queued sync items are automatically processed if GitHub is configured. Manual push/pull from Settings resets retry state and clears the queue on success.

## 2026-02-15
Implemented manual GitHub Sync push and pull (Step 7). Push creates a single atomic Git commit with incremental changes (added, modified, deleted bottles) as `wines/{type}/wine-{uuid}.json` files with consistent key ordering and pretty-printed JSON. Pull fetches all wine files from GitHub and replaces local IndexedDB data. Added Push/Pull buttons to Settings view with loading states, success/error feedback, and a "Syncing..." header indicator during operations. Created bottle serialization utilities and GitHub sync module with comprehensive tests.

## 2026-02-15
Implemented GitHub Integration settings and authentication (Step 6). Added a Settings view where users configure their private GitHub repository (owner/repo format) and Personal Access Token, test the connection (verifying PAT validity and read/write access via Octokit), save credentials to localStorage, and disconnect. The header sync status indicator now dynamically shows "Not configured" or "Connected" based on stored settings. Added GitHub API client module, settings storage utilities, and form validation with comprehensive tests. Raised bundle size target from ~15-20kb to ~50kb to accommodate Octokit.

## 2026-02-14
Initialized the My Cellar project with Svelte 5, Vite, Tailwind CSS v4, and Vitest. Set up a mobile-first layout shell with bottom tab bar navigation (Dashboard, Add, Search, Settings), hash-based routing, and placeholder views. Added GitHub Actions workflow for automated deployment to GitHub Pages.

Added data model and local storage layer. Defined TypeScript types for bottles, history entries, and prices. Implemented IndexedDB-based persistence using the `idb` library with full CRUD operations. Created utility functions for quantity calculation from history and duplicate detection (type + vintage + name matching).

Implemented the Dashboard view as the default landing page. Displays cellar statistics (total bottle count, breakdown by wine type, top 3 regions), a feed of the 10 most recent activity entries, and an empty state with CTA button when no bottles exist. Updated the sync status badge to read "Offline". Added dashboard utility functions with comprehensive unit tests and Dashboard component integration tests.

Implemented the Add Bottle form view. Users can add new wines with all required fields (name, vintage, type, country, region, quantity) and optional fields (grape varieties as free-text tags, location, rating, price with currency defaulting to EUR, notes). Form validates required fields inline on submit. Duplicate detection (type + vintage + name, case-insensitive) shows a confirmation banner to merge quantity into the existing bottle's history. Extracted reusable FormField and GrapeTagInput sub-components. Added form validation utility with unit tests (24 tests) and AddBottle integration tests (13 tests).

Implemented the Search & Filter view. Users can search bottles by name (case-insensitive partial match), filter by wine type, country, region, vintage range, and minimum rating. Filters are presented in a collapsible panel with active filter count badge. Results are sortable by name (default), vintage, rating, quantity, or recently added. All filter options (country, region) are dynamically derived from cellar contents. Bottles are displayed as read-only cards showing name, vintage, type badge, origin, quantity, and rating. Includes empty states for both empty cellar (with CTA) and no matching results. Added search utility functions with unit tests (28 tests), BottleCard tests (5 tests), FilterPanel tests (9 tests), and Search view integration tests (11 tests).
